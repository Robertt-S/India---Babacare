{% extends 'layout.html' %}

{%block title%}
    Chat
{%endblock%}

{%block content%}
<html>
  <body>

    <center style="font-size: 1.5rem;">Olá {{request.user.nome}}!</center>
    <br>
    {% if request.user.is_authenticated  %}
      
      {% if user.isBaba == True %}
      <div><a href = "{% url 'perfis:gerenciar_servicos' %}">RETURN</a></div>
      {% else %}
      <div><a href = "{% url 'users:servicos_responsavel' %}">RETURN</a></div>
      {%endif%}
    {% comment %} request.user é o base user {% endcomment %}
    {% endif %}
    <div class="chat_container">
      <br/>
      {% comment %} Logo em cima da caixa {% endcomment %}
      <div class="chat_background">
        {% comment %} dentro da caixa roxa {% endcomment %}
        <div class="chat_message" id="id_chat_item_container" ></div>
      </div>
      <div class="chat_input">
        <input type="text" id="id_message_send_input" />
        <button type="submit" id="id_message_send_button">Send Message</button>
      </div>  
    </div>


    <script>
      const chatSocket = new WebSocket("ws://" + window.location.host + "/");


      document.querySelector("#id_message_send_input").focus();

      // Quando o botão de submit é clicado ou Enter
      document.querySelector("#id_message_send_input").onkeyup = function (e) {
        if (e.keyCode == 13) {
          document.querySelector("#id_message_send_button").click();
        }
      };
      document.querySelector("#id_message_send_button").onclick = function (e) {
        var messageInput = document.querySelector(
          "#id_message_send_input"
        ).value;
        chatSocket.send(JSON.stringify({ 
          message: messageInput, 
          username : "{{ request.user.nome }}",
          user_avatar : "{{ request.user.foto.url }}"
        }));
      };

      // Quando uma mensagem é recebida
      chatSocket.onmessage = function (e) {
        // JSON -> objeto JavaScript
        const data = JSON.parse(e.data);

        // O que aparece na caixa de mensagem_input
        document.querySelector("#id_message_send_input").value = "";

        // Formato mensagem
        /*<div class="message">
          {{data.username}} 
            <br>{{data.message}}
        <div/>*/
        var div = document.createElement("div");
        div.classList.add("message");
        div.innerHTML = data.username + "<br>" + "&emsp;&emsp;" + data.message;

        // Adicionar alguma mensagem ao contêiner
        var messageContainer = document.createElement("div");
        messageContainer.classList.add("message-container");
        messageContainer.appendChild(div);

        if (data.username === "{{ request.user.nome }}") {
          messageContainer.classList.add("my-message");
        } 
        else {
            messageContainer.classList.add("other-message");
        }

        // Criar a imagem do usuário
        var img = document.createElement("img");
        img.src = data.user_avatar;
        img.alt = data.username;
        img.classList.add("avatar");

        // Adicionar a imagem e a mensagem ao contêiner
        messageContainer.appendChild(img);


        // Adicionar o contêiner ao chat
        var chatContainer = document.querySelector("#id_chat_item_container");
        chatContainer.appendChild(messageContainer);

        chatContainer.scrollTop = chatContainer.scrollHeight;
      };
    </script>


  </body>
</html>
{% endblock content %}